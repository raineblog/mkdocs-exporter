\batchmode

\makeatletter
\def\Gin@log#1{} 
\long\def\PackageInfo#1#2{}
\def\AM@Message#1{}

% 定义 \subtitle
\newcommand{\subtitle}[1]{\def\@subtitle{#1}}
\def\@subtitle{}

% 预定义可能缺失的宏
\newcommand{\bookabstract}{}
\newcommand{\bookpublishing}{}
\makeatother

\hbadness=10000
\vbadness=10000
\hfuzz=\maxdimen
\vfuzz=\maxdimen

\RequirePackage{silence}
\WarningsOff*

% =================================================================

\documentclass[a4paper,12pt,twoside,openright]{ctexbook}
% ====================
% 1. 基础宏包配置
% ====================
\usepackage{geometry}
\geometry{
    a4paper,
    top=2.54cm, bottom=2.54cm,
    left=3.18cm, right=2.54cm, % 内侧留白大一点用于装订
}

\usepackage{pdfpages} % 核心：插入PDF
\usepackage{luacode}  % 核心：Lua代码
\usepackage{hyperref} % 书签和链接
\usepackage{xcolor}
\usepackage{titlesec} % 标题样式
\usepackage{fancyhdr} % 页眉页脚
\setlength{\headheight}{8pt}
\usepackage{etoolbox} % 编程逻辑
\usepackage{metalogox}
\usepackage{tikz}


% 配色 (深蓝灰，显得高级)
\definecolor{maincolor}{RGB}{45, 52, 54}
\definecolor{accentcolor}{RGB}{9, 132, 227}
\definecolor{darkblue}{RGB}{0, 0, 139}
\definecolor{gradientstart}{RGB}{176, 192, 222} % 雾霾蓝
\definecolor{gradientend}{RGB}{164, 176, 190}   % 偏灰

% 超链接设置
\hypersetup{
    colorlinks=true,
    linkcolor=maincolor,
    urlcolor=accentcolor,
    pdftitle={My Auto Book},
    pdfauthor={Author},
    bookmarksnumbered=true
}

% ====================
% 2. 版面设计 (高雅风格)
% ====================

% 字体设置 (根据环境自动回退，建议在 CI 中安装 Noto CJK)
% 默认 ctex 已经处理得很好，这里可以不做额外设置

% 章节标题样式 (Chapter)
% 效果：右对齐，巨大的数字，下方是标题
\titleformat{\chapter}[display]
  {\normalfont\huge\bfseries\color{maincolor}}
  {\flushright\fontsize{60}{60}\selectfont\thechapter}
  {20pt}
  {\flushright\Huge}
\titlespacing*{\chapter}{0pt}{50pt}{40pt}

% 目录样式 (使用 tocloft 以实现更灵活和自动的对齐)
\usepackage{tocloft}
\usepackage{calc}

% --- 全局目录设置 ---
% 设置页码的宽度和右边距，确保所有条目右对齐
\cftsetpnumwidth{2.5em}
\cftsetrmarg{3em}

% --- 章节 (chapter) 样式 ---
% 1. 估算最长章节编号的宽度 (例如 "第二十二章")，并以此为基准对齐
\newlength{\chapnumwidth}
\settowidth{\chapnumwidth}{\bfseries 第二十二章}
\addtolength{\chapnumwidth}{1em} % 增加一点额外的间距

% 2. 设置章节样式
\renewcommand{\cftchapfont}{\bfseries} % 章节标题加粗
\renewcommand{\cftchappagefont}{\normalfont} % 页码正常字体
\renewcommand{\cftchapleader}{\cftdotfill{\cftdotsep}} % 使用点状引导线
% 3. 设置缩进：左边距为0，编号区域宽度为上面计算的值
\cftsetindents{chapter}{0em}{\chapnumwidth}

% --- 小节 (section) 样式 ---
% 1. 估算最长节编号的宽度 (例如 "22.22")
\newlength{\secnumwidth}
\settowidth{\secnumwidth}{22.22}
\addtolength{\secnumwidth}{1em} % 增加一点额外的间距

% 2. 设置节的缩进：左边距为章节编号的宽度，保证节标题对齐
\cftsetindents{section}{\chapnumwidth}{\secnumwidth}
\renewcommand{\cftsecleader}{\cftdotfill{\cftdotsep}} % 使用点状引导线

% 页眉页脚
\pagestyle{fancy}
\fancyhf{}
\fancyhead[LO]{\small\itshape\leftmark}
\fancyhead[RE]{\small\itshape\rightmark}
\fancyfoot[LO,RE]{\small\thepage}
\renewcommand{\headrulewidth}{0pt} % 去掉页眉横线，更极简

% ====================
% 3. Lua 脚本：读取 JSON 并生成内容
% ====================

\begin{luacode*}
    require("lualibs") 
    
    function process_book_structure()
        -- 1. 读取文件
        local f = io.open("toc.json", "rb")
        if not f then
            tex.error("Lua Error: 'toc.json' not found in " .. lfs.currentdir())
            return
        end
        local content = f:read("*all")
        f:close()

        -- 去除 UTF-8 BOM
        if string.byte(content, 1) == 0xEF and string.byte(content, 2) == 0xBB and string.byte(content, 3) == 0xBF then
            content = string.sub(content, 4)
        end

        -- 3. 解析 JSON
        local data = utilities.json.tolua(content)

        -- 4. 核心修复：检查 data 是否为空
        if not data then
            tex.error("Lua Error: JSON parsing failed! content might be empty or invalid encoding.")
            return
        end
        
        -- 5. 正常的处理逻辑
        tex.print("\\title{" .. (data.title or "Untitled"):gsub("#", "\\#") .. "}")
        tex.print("\\subtitle{" .. (data.subtitle or ""):gsub("#", "\\#") .. "}")

        if data.authors then
            local authors = {}
            for i, a in ipairs(data.authors) do authors[i] = a:gsub("#", "\\#") end
            tex.print("\\author{" .. table.concat(authors, "　") .. "}")
        end
        tex.print("\\date{" .. (data.date or "\\today") .. "}")
        
        if data.info then
            if data.info.abstract then
                tex.print("\\renewcommand{\\bookabstract}{")
                for _, para in ipairs(data.info.abstract) do
                    tex.print(para:gsub("#", "\\#") .. "\\par\\vspace{0.5em}")
                end
                tex.print("}")
            end
            if data.info.publishing then
                tex.print("\\renewcommand{\\bookpublishing}{" .. data.info.publishing:gsub("#", "\\#") .. "}")
            end
        end
        
        -- 兼容 sections 字段名
        _G.book_content = data.sections or data.content
    end

    function print_chapters_and_sections()
        if not _G.book_content then return end
        
        for i, chapter in ipairs(_G.book_content) do
            tex.print("\\chapter{" .. (chapter.title or "Chapter") .. "}")
            -- 兼容 sections 字段名
            local sections = chapter.sections or chapter.content
            if sections then
                for j, section in ipairs(sections) do
                    -- 兼容 path 字段名
                    local file_path = section.path or section.file
                    local sec_title = section.title or "Section"
                    
                    -- 检查文件路径是否为空
                    if file_path and file_path ~= "" then
                        -- 这里如果不转义路径中的特殊字符可能会有问题，但在 Windows 路径通常斜杠处理要注意
                        -- 最好在 Python 端把路径都转为正斜杠 /
                        local options = "pages=-, width=\\paperwidth, height=\\paperheight, " ..
                                        "pagecommand={\\thispagestyle{fancy}}, " .. 
                                        "addtotoc={1, section, 1, {" .. sec_title .. "}, sec:" .. i .. "-" .. j .. "}"
                        tex.print("\\includepdf[" .. options .. "]{" .. file_path .. "}")
                    end
                end
            end
        end
    end
\end{luacode*}

% 初始化数据
\directlua{process_book_structure()}

\begin{document}

% ====================
% 4. 封面与前言 (Front Matter)
% ====================
\frontmatter

% --- 封面 ---
\begin{titlepage}
    \phantomsection
    \addcontentsline{toc}{chapter}{封面}
    \centering
    \vspace*{4cm}
    
    {\fontsize{40}{48}\selectfont \bfseries \makeatletter \@title \makeatother \par}
    \vspace{1cm}
    {\huge \itshape \color{gray} \makeatletter \@subtitle \makeatother \par}
    \vspace{3cm}
    {\large \makeatletter \@author \makeatother \par}
    
    \vfill

    {\large \itshape \color{darkblue} \makeatletter \@date \makeatother \par}
    \vspace{1cm}
    {\large \bookpublishing \par}
\end{titlepage}

% --- 扉页/致谢/摘要 ---
\newpage
\phantomsection
\addcontentsline{toc}{chapter}{扉页}
\thispagestyle{empty}
\vspace*{3cm}
\begin{center}
    {\Large \textbf{本书简介}} \par
    \vspace{1cm}
    \begin{minipage}{0.7\textwidth}
        \setlength{\parindent}{2em}
        \bookabstract
    \end{minipage}
\end{center}
\vfill
\begin{center}
    \textit{献给 佐倉杏子}
\end{center}
\cleardoublepage

% --- 目录 ---
\phantomsection
\addcontentsline{toc}{chapter}{目录}
{
    \hypersetup{linkcolor=black}
    \tableofcontents
}
\cleardoublepage

% ====================
% 5. 正文 (Main Matter)
% ====================
\mainmatter

% 调用 Lua 循环插入所有 PDF
\directlua{print_chapters_and_sections()}

% ====================
% 6. 封底 (Back Matter)
% ====================
\backmatter
\cleardoublepage
\phantomsection
\addcontentsline{toc}{chapter}{封底}
\thispagestyle{empty}
\begin{tikzpicture}[remember picture, overlay]
    \shade[top color=gradientstart, bottom color=gradientend]
        (current page.south west) rectangle (current page.north east);
\end{tikzpicture}
\vspace*{\fill}
\begin{center}
    {\Large\textbf{Thanks for Reading}} \\
    \vspace{1cm}
    {\small Generated by \LuaLaTeX.}
\end{center}
\vspace*{\fill}

\end{document}
